<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cricket Score Management</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: white;
      text-align: center;
      padding: 20px;
    }
    h1, h2 {
      margin-bottom: 10px;
    }
    .scoreboard, .controls {
      background: #1e1e1e;
      padding: 20px;
      margin: 20px auto;
      border-radius: 10px;
      max-width: 600px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    select, button {
      margin: 5px;
      padding: 8px;
      border-radius: 5px;
      border: none;
    }
    button {
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>
  <h1>Live Cricket Scoring</h1>

  <div class="scoreboard">
    <h2 id="teamName">Team</h2>
    <p id="teamScore">Score: 0/0 (0.0 overs)</p>
    <p id="netRunRate">NRR: 0.00</p>
    <p id="currentBatting">Currently batting: None</p>
    <p id="currentPlayers">Striker: None | Non-Striker: None</p>
    <p id="currentBowler">Bowler: None</p>
  </div>

  <div class="controls">
    <h3>Update Players</h3>
    <select id="strikerSelect"></select>
    <select id="nonStrikerSelect"></select>
    <select id="bowlerSelect"></select>
    <button onclick="setPlayers()">Set Players</button>

    <h3>Scoring</h3>
    <button onclick="applyRuns(0)">0</button>
    <button onclick="applyRuns(1)">1</button>
    <button onclick="applyRuns(2)">2</button>
    <button onclick="applyRuns(3)">3</button>
    <button onclick="applyRuns(4)">4</button>
    <button onclick="applyRuns(6)">6</button>
    <button onclick="applyWicket()">Wicket</button>
    <button onclick="applyExtras(1)">Wide/No Ball</button>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbyYkUO01c9FpoLwGj_y8ALbPt2_WVvac_W1QxGNkqKnp54VRb6wBEPKmEzpOjuP-7fP6Q/exec";

    let score = 0, wickets = 0, balls = 0, overs = 0;
    let striker = "None", nonStriker = "None", bowler = "None";
    let battingTeam = null, bowlingTeam = null;
    const tournamentData = JSON.parse(localStorage.getItem("tournamentData"));
    let lastAction = null;

    function loadTeams() {
      if (tournamentData) {
        // Decide first batting side based on toss winner & decision
        if (tournamentData.toss && tournamentData.toss.winner && tournamentData.toss.decision) {
          const winner = tournamentData.toss.winner;    // "team1" or "team2"
          const decision = tournamentData.toss.decision; // "bat" or "bowl"
          const team1 = tournamentData.team1;
          const team2 = tournamentData.team2;

          if (decision === "bat") {
            battingTeam = winner === "team1" ? team1 : team2;
            bowlingTeam = winner === "team1" ? team2 : team1;
          } else {
            battingTeam = winner === "team1" ? team2 : team1;
            bowlingTeam = winner === "team1" ? team1 : team2;
          }
        } else {
          battingTeam = tournamentData.team1;
          bowlingTeam = tournamentData.team2;
        }

        document.getElementById("teamName").innerText = battingTeam.name;
        populateDropdown("strikerSelect", battingTeam.players);
        populateDropdown("nonStrikerSelect", battingTeam.players);
        populateDropdown("bowlerSelect", bowlingTeam.players);
      } else {
        battingTeam = { name: "Team A", players: [] };
        bowlingTeam = { name: "Team B", players: [] };
      }
      updateDisplay();
    }

    function populateDropdown(id, players) {
      const dropdown = document.getElementById(id);
      dropdown.innerHTML = "<option value=''>Select</option>";
      players.forEach(p => {
        if (p.trim()) {
          const option = document.createElement("option");
          option.value = p;
          option.text = p;
          dropdown.add(option);
        }
      });
    }

    function setPlayers() {
      striker = document.getElementById("strikerSelect").value || striker;
      nonStriker = document.getElementById("nonStrikerSelect").value || nonStriker;
      bowler = document.getElementById("bowlerSelect").value || bowler;
      updateDisplay();
    }

    function applyRuns(runs) {
      score += runs;
      lastAction = { type: "run", value: runs };
      if (runs % 2 !== 0) { [striker, nonStriker] = [nonStriker, striker]; }
      balls++;
      if (balls === 6) { overs++; balls = 0; [striker, nonStriker] = [nonStriker, striker]; }
      updateDisplay();
    }

    function applyWicket() {
      wickets++;
      lastAction = { type: "wicket" };
      balls++;
      if (balls === 6) { overs++; balls = 0; [striker, nonStriker] = [nonStriker, striker]; }
      updateDisplay();
    }

    function applyExtras(extraRuns) {
      score += extraRuns;
      lastAction = { type: "extra", value: extraRuns };
      updateDisplay();
    }

    function updateDisplay() {
      document.getElementById("teamScore").innerText = `Score: ${score}/${wickets} (${overs}.${balls} overs)`;
      const totalOvers = overs + balls / 6;
      const nrr = totalOvers > 0 ? (score / totalOvers).toFixed(2) : "0.00";
      document.getElementById("netRunRate").innerText = `NRR: ${nrr}`;
      document.getElementById("currentBatting").innerText = `Currently batting: ${battingTeam ? battingTeam.name : "None"}`;
      document.getElementById("currentPlayers").innerText = `Striker: ${striker} | Non-Striker: ${nonStriker}`;
      document.getElementById("currentBowler").innerText = `Bowler: ${bowler}`;
      saveToSheets();
    }

    function saveToSheets() {
      const data = {
        team: battingTeam ? battingTeam.name : "Team",
        runs: score,
        wickets: wickets,
        overs: `${overs}.${balls}`,
        striker: striker,
        nonStriker: nonStriker,
        bowler: bowler
      };
      fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify(data),
        headers: { "Content-Type": "application/json" }
      }).catch(err => console.error("Error saving to Sheets:", err));
    }

    loadTeams();
  </script>
</body>
</html>
