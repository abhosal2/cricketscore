<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scorer Panel</title>

  <!-- üîí Protect scoring page -->
  <script>
    const scorerSession = localStorage.getItem("scorerSession");
    if (!scorerSession) {
      window.location.href = "login.html"; // not logged in ‚Üí redirect
    }
  </script>

  <style>
    body {
      font-family: "Copperplate Gothic Light", Arial, sans-serif;
      background: #121212;
      color: white;
      text-align: center;
      padding: 20px;
    }

    .scoreboard, .controls, .selectors, .extras {
      background: #1e1e2f;
      padding: 20px;
      margin: 20px auto;
      border-radius: 10px;
      width: 85%;
      max-width: 950px;
      box-shadow: 0 0 10px #8384D4;
    }

    h1, h2, h3 {
      color: #8384D4;
      margin: 8px 0;
    }

    select, button, input[type="number"], input[type="text"] {
      margin: 6px;
      padding: 10px 14px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      outline: none;
    }

    select, input[type="number"], input[type="text"] {
      background: #222;
      color: #fff;
    }

    button {
      background: #8384D4;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background: #6c6db8;
    }

    button:disabled {
      background: #444;
      cursor: not-allowed;
    }

    .warn {
      border: 2px solid #ff5252;
      border-radius: 10px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      align-items: center;
    }
  </style>
</head>
<body>
  <h1>üèè Scorer Panel</h1>

  <div class="scoreboard">
    <h2 id="battingTeam">Batting Team: Loading...</h2>
    <h2 id="bowlingTeam">Bowling Team: Loading...</h2>
    <p id="score">Score: 0/0 (0.0 overs)</p>
    <p id="nrr">NRR: 0.00</p>

    <!-- Striker/Non-striker with stats -->
    <p id="striker">Striker: None</p>
    <p id="nonStriker">Non-Striker: None</p>
    <!-- Bowler stats -->
    <p id="bowler">Bowler: None</p>
  </div>

  <!-- Player selectors -->
  <div class="selectors" id="selectorsBox">
    <h3>‚ö° Select Players Before Scoring</h3>
    <div class="row">
      <label>Striker:</label>
      <select id="strikerSelect"><option value="">-- Select --</option></select>

      <label>Non-Striker:</label>
      <select id="nonStrikerSelect"><option value="">-- Select --</option></select>

      <label>Bowler:</label>
      <select id="bowlerSelect"><option value="">-- Select --</option></select>
    </div>
    <div class="row">
      <button id="btnConfirmInitial" onclick="confirmPlayers()">Confirm Players</button>
      <button id="btnConfirmNewBat" style="display:none;" onclick="setNewBatsman()">Confirm New Batsman</button>
      <button id="btnConfirmNewBowler" style="display:none;" onclick="setNewBowler()">Confirm New Bowler</button>
    </div>

    <!-- Dismissal type + fielder input -->
    <div class="row">
      <label for="dismissalType">Dismissal Type:</label>
      <select id="dismissalType">
        <option value="bowled">Bowled</option>
        <option value="caught">Caught</option>
        <option value="lbw">LBW</option>
        <option value="run out">Run Out</option>
        <option value="stumped">Stumped</option>
        <option value="hit wicket">Hit Wicket</option>
      </select>

      <label for="fielderName">Fielder (optional):</label>
      <input type="text" id="fielderName" placeholder="Enter fielder name">
    </div>
  </div>

  <!-- Scoring controls -->
  <div class="controls">
    <div class="row">
      <button id="btn1" onclick="addRun(1)" disabled>+1 Run</button>
      <button id="btn2" onclick="addRun(2)" disabled>+2 Runs</button>
      <button id="btn4" onclick="addRun(4)" disabled>+4 Runs</button>
      <button id="btn6" onclick="addRun(6)" disabled>+6 Runs</button>
      <button id="btnW" onclick="addWicket()" disabled>Wicket</button>
    </div>
    <div class="row">
      <button id="btnSwap" onclick="swapStrike(true)" disabled>Swap Strike</button>
      <button id="btnUndo" onclick="undo()" disabled>Undo</button>
      <button id="btnEnd" onclick="endInnings()" disabled>End Innings</button>
      <button onclick="window.location.href='display.html'">Go to Display Page</button>
    </div>
  </div>

  <!-- Extras -->
  <div class="extras">
    <h3>‚ûï Extras</h3>
    <div class="row">
      <label for="extrasType">Type:</label>
      <select id="extrasType">
        <option value="wide">Wide</option>
        <option value="no_ball">No Ball</option>
        <option value="leg_bye">Leg Bye</option>
      </select>

      <label for="extrasRuns">Runs:</label>
      <input type="number" id="extrasRuns" min="1" value="1" />

      <button id="btnExtra" onclick="addExtra()" disabled>Add Extra</button>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://ukziqsqffdavuctzyngn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVremlxc3FmZmRhdnVjdHp5bmduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzA4MDQsImV4cCI6MjA3MzYwNjgwNH0.d8c2lnVKhoVLHHI3pKBLr9kaE1zB-ll5CjvFE8bZxQs";
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ------- STATE -------
    let matchId = localStorage.getItem("matchId");
    let runs = 0, wickets = 0, overs = 0, balls = 0; // overs + balls (0..5)
    let striker = "None", non_striker = "None", bowler = "None", commentary = "";
    let battingTeam = "", bowlingTeam = "";
    let battingPlayers = [], bowlingPlayers = [];
    let team1Captain = "", team2Captain = "";
    let waitingNewBatsman = false, waitingNewBowler = false;

    const history = []; // for Undo

    // ------- HELPERS -------
    function pushSnapshot(type, data={}) {
      history.push({ type, data, runs, wickets, overs, balls, striker, non_striker, bowler, commentary });
      document.getElementById("btnUndo").disabled = false;
    }
    function restoreSnapshot(snap) {
      runs = snap.runs; wickets = snap.wickets; overs = snap.overs; balls = snap.balls;
      striker = snap.striker; non_striker = snap.non_striker; bowler = snap.bowler;
      commentary = snap.commentary || "";
    }
    function oversDecimal() {
      // store overs as x.y where y=balls (0..5)
      return parseFloat((overs + balls / 10).toFixed(1));
    }
    function updateDisplay() {
      document.getElementById("score").textContent = `Score: ${runs}/${wickets} (${overs}.${balls} overs)`;
      document.getElementById("striker").textContent = `Striker: ${striker}`;
      document.getElementById("nonStriker").textContent = `Non-Striker: ${non_striker}`;
      document.getElementById("bowler").textContent = `Bowler: ${bowler}`;
      document.getElementById("battingTeam").textContent = `Batting Team: ${battingTeam}`;
      document.getElementById("bowlingTeam").textContent = `Bowling Team: ${bowlingTeam}`;
      const o = overs + balls/6;
      document.getElementById("nrr").textContent = o > 0 ? (runs / o).toFixed(2) : "0.00";
    }
    async function saveScore() {
      // Ensure a row exists and upsert latest values
      await supabaseClient.from("scores").upsert({
        match_id: matchId,
        runs, wickets,
        overs: oversDecimal(),       // store as decimal (x.y with balls)
        striker, non_striker, bowler,
        commentary
      }, { onConflict: "match_id" });
    }
    async function ensureBattingRow(player) {
      if (!player || player === "None") return;
      const { data } = await supabaseClient.from("batting_stats")
        .select("id").eq("match_id", matchId).eq("player_name", player).maybeSingle();
      if (!data) {
        await supabaseClient.from("batting_stats").insert({
          match_id: matchId,
          player_name: player,
          runs: 0, balls: 0, fours: 0, sixes: 0, is_out: false
        });
      }
    }
    async function ensureBowlingRow(player) {
      if (!player || player === "None") return;
      const { data } = await supabaseClient.from("bowling_stats")
        .select("id").eq("match_id", matchId).eq("bowler_name", player).maybeSingle();
      if (!data) {
        await supabaseClient.from("bowling_stats").insert({
          match_id: matchId,
          bowler_name: player,
          overs: 0, runs_conceded: 0, wickets: 0
        });
      }
    }
    async function incBatting(player, r, isBall=true) {
      if (!player || player==="None") return;
      const incs = {};
      if (isBall) incs.balls = supabase.sql`balls + 1`;
      if (r>0) incs.runs = supabase.sql`runs + ${r}`;
      if (r===4) incs.fours = supabase.sql`fours + 1`;
      if (r===6) incs.sixes = supabase.sql`sixes + 1`;
      if (Object.keys(incs).length===0) return;
      await supabaseClient.from("batting_stats")
        .update(incs).eq("match_id", matchId).eq("player_name", player);
    }
    async function incBowlingRuns(player, r) {
      if (!player || player==="None" || r<=0) return;
      await supabaseClient.from("bowling_stats")
        .update({ runs_conceded: supabase.sql`runs_conceded + ${r}` })
        .eq("match_id", matchId).eq("bowler_name", player);
    }
    async function incBowlingWicket(player) {
      if (!player || player==="None") return;
      await supabaseClient.from("bowling_stats")
        .update({ wickets: supabase.sql`wickets + 1` })
        .eq("match_id", matchId).eq("bowler_name", player);
    }
    async function incBowlerOver(player) {
      if (!player || player==="None") return;
      await supabaseClient.from("bowling_stats")
        .update({ overs: supabase.sql`overs + 1` })
        .eq("match_id", matchId).eq("bowler_name", player);
    }

    // ------- LOAD TEAMS / PLAYERS -------
    async function loadTeams() {
      if (!matchId) return;

      // Load existing score row if any
      const { data: existingScore } = await supabaseClient
        .from("scores").select("*").eq("match_id", matchId).maybeSingle();
      if (existingScore) {
        runs = existingScore.runs || 0;
        wickets = existingScore.wickets || 0;
        // overs as decimal x.y -> split
        if (typeof existingScore.overs === "number") {
          const ov = existingScore.overs;
          overs = Math.floor(ov);
          balls = Math.round((ov - overs) * 10); // because we saved x.y with y=balls
        }
        striker = existingScore.striker || "None";
        non_striker = existingScore.non_striker || "None";
        bowler = existingScore.bowler || "None";
        commentary = existingScore.commentary || "";
      }

      const { data: matchData, error: mErr } = await supabaseClient
        .from("matches")
        .select("team1_id, team2_id, toss_winner, toss_decision")
        .eq("id", matchId)
        .single();
      if (mErr || !matchData) { console.error("Error loading match:", mErr); return; }

      const { data: team1 } = await supabaseClient.from("teams").select("id, name, captain").eq("id", matchData.team1_id).single();
      const { data: team2 } = await supabaseClient.from("teams").select("id, name, captain").eq("id", matchData.team2_id).single();
      if (!team1 || !team2) return;
      team1Captain = team1.captain || "";
      team2Captain = team2.captain || "";

      const team1Players = (await supabaseClient.from("players").select("name").eq("team_id", team1.id)).data?.map(p=>p.name) || [];
      const team2Players = (await supabaseClient.from("players").select("name").eq("team_id", team2.id)).data?.map(p=>p.name) || [];

      // Decide batting/bowling order from toss
      if (matchData.toss_winner === "team1" && matchData.toss_decision === "bat") {
        battingTeam = team1.name; bowlingTeam = team2.name;
        battingPlayers = team1Players; bowlingPlayers = team2Players;
      } else if (matchData.toss_winner === "team1" && matchData.toss_decision === "bowl") {
        battingTeam = team2.name; bowlingTeam = team1.name;
        battingPlayers = team2Players; bowlingPlayers = team1Players;
      } else if (matchData.toss_winner === "team2" && matchData.toss_decision === "bat") {
        battingTeam = team2.name; bowlingTeam = team1.name;
        battingPlayers = team2Players; bowlingPlayers = team1Players;
      } else {
        battingTeam = team1.name; bowlingTeam = team2.name;
        battingPlayers = team1Players; bowlingPlayers = team2Players;
      }

      // Populate dropdowns (append (C) visually)
      const strikerSel = document.getElementById("strikerSelect");
      const nonStrikerSel = document.getElementById("nonStrikerSelect");
      const bowlerSel = document.getElementById("bowlerSelect");
      strikerSel.innerHTML = "<option value=''>-- Select --</option>";
      nonStrikerSel.innerHTML = "<option value=''>-- Select --</option>";
      bowlerSel.innerHTML = "<option value=''>-- Select --</option>";

      const battingCaptain = (battingTeam === team1.name) ? team1Captain : team2Captain;
      const bowlingCaptain = (bowlingTeam === team1.name) ? team1Captain : team2Captain;

      battingPlayers.forEach(p => {
        const label = (p === battingCaptain && p) ? `${p} (C)` : p;
        strikerSel.innerHTML += `<option value="${p}">${label}</option>`;
        nonStrikerSel.innerHTML += `<option value="${p}">${label}</option>`;
      });
      bowlingPlayers.forEach(p => {
        const label = (p === bowlingCaptain && p) ? `${p} (C)` : p;
        bowlerSel.innerHTML += `<option value="${p}">${label}</option>`;
      });

      document.getElementById("battingTeam").textContent = `Batting Team: ${battingTeam}`;
      document.getElementById("bowlingTeam").textContent = `Bowling Team: ${bowlingTeam}`;

      // If we had names already saved in scores row, reflect them in selectors and UI
      if (striker !== "None") strikerSel.value = striker;
      if (non_striker !== "None") nonStrikerSel.value = non_striker;
      if (bowler !== "None") bowlerSel.value = bowler;

      updateDisplay();
      // If no score row yet, create one
      await saveScore();
    }

    // ------- CONFIRM / NEW SELECTIONS -------
    async function confirmPlayers() {
      striker = document.getElementById("strikerSelect").value;
      non_striker = document.getElementById("nonStrikerSelect").value;
      bowler = document.getElementById("bowlerSelect").value;

      if (!striker || !non_striker || !bowler) {
        alert("Please select striker, non-striker, and bowler before starting!");
        return;
      }
      if (striker === non_striker) {
        alert("Striker and Non-Striker must be different players.");
        return;
      }

      await ensureBattingRow(striker);
      await ensureBattingRow(non_striker);
      await ensureBowlingRow(bowler);

      // Lock selections (initial)
      document.getElementById("selectorsBox").classList.remove("warn");
      document.querySelectorAll("#selectorsBox select").forEach(el => el.disabled = true);
      document.getElementById("btnConfirmInitial").disabled = true;

      // Enable scoring buttons
      document.querySelectorAll(".controls button, .extras button").forEach(el => el.disabled = false);

      await saveScore();
      updateDisplay();
    }

    function requireNewBatsman() {
      waitingNewBatsman = true;
      // Unlock just striker select for new batsman
      document.getElementById("strikerSelect").disabled = false;
      document.getElementById("btnConfirmNewBat").style.display = "inline-block";
      // prevent scoring while waiting
      document.querySelectorAll(".controls button, .extras button").forEach(el => el.disabled = true);
      document.getElementById("btnConfirmNewBat").disabled = false;
    }
    async function setNewBatsman() {
      const newBat = document.getElementById("strikerSelect").value;
      if (!newBat || newBat === non_striker) {
        alert("Select a valid new batsman (not the non-striker).");
        return;
      }
      striker = newBat;
      await ensureBattingRow(striker);

      waitingNewBatsman = false;
      document.getElementById("strikerSelect").disabled = true;
      document.getElementById("btnConfirmNewBat").style.display = "none";
      // re-enable scoring
      document.querySelectorAll(".controls button, .extras button").forEach(el => el.disabled = false);

      commentary = `${striker} comes to the crease.`;
      await saveScore();
      updateDisplay();
    }

    function requireNewBowler() {
      waitingNewBowler = true;
      document.getElementById("bowlerSelect").disabled = false;
      document.getElementById("btnConfirmNewBowler").style.display = "inline-block";
      document.querySelectorAll(".controls button, .extras button").forEach(el => el.disabled = true);
      document.getElementById("btnConfirmNewBowler").disabled = false;
    }
    async function setNewBowler() {
      const newBow = document.getElementById("bowlerSelect").value;
      if (!newBow) { alert("Select a bowler."); return; }
      bowler = newBow;
      await ensureBowlingRow(bowler);

      waitingNewBowler = false;
      document.getElementById("bowlerSelect").disabled = true;
      document.getElementById("btnConfirmNewBowler").style.display = "none";
      document.querySelectorAll(".controls button, .extras button").forEach(el => el.disabled = false);

      commentary = `New over by ${bowler}.`;
      await saveScore();
      updateDisplay();
    }

    // ------- SCORING LOGIC -------
    function advanceBallAndMaybeOver() {
      balls++;
      if (balls >= 6) {
        balls = 0;
        overs++;
        // strike rotates at end of over
        [striker, non_striker] = [non_striker, striker];
        return true; // over ended
      }
      return false;
    }

    async function addRun(r) {
      if (waitingNewBatsman || waitingNewBowler) return;
      pushSnapshot("run", { runs: r, striker });

      runs += r;
      // This is a legal ball
      const overEnded = advanceBallAndMaybeOver();

      // rotate strike on odd runs
      if (!overEnded && r % 2 === 1) {
        [striker, non_striker] = [non_striker, striker];
      }

      // stats
      await ensureBattingRow(striker);
      await incBatting(striker, r, true);
      await ensureBowlingRow(bowler);
      await incBowlingRuns(bowler, r);
      if (overEnded) await incBowlerOver(bowler);

      commentary = `${striker} scores ${r} run${r>1?"s":""}.`;
      await saveScore();
      updateDisplay();

      if (overEnded) requireNewBowler();
    }

    async function addExtra() {
      if (waitingNewBatsman || waitingNewBowler) return;
      const type = document.getElementById("extrasType").value;
      const x = parseInt(document.getElementById("extrasRuns").value || "1", 10);
      if (x <= 0) return;

      pushSnapshot("extra", { type, runs: x });

      if (type === "wide" || type === "no_ball") {
        // does NOT count as a ball
        runs += x;
        await ensureBowlingRow(bowler);
        await incBowlingRuns(bowler, x);
        commentary = `${type.replace("_"," ")} +${x}`;
        // no strike change unless odd BYEs on a legal ball (not here)
      } else if (type === "leg_bye") {
        // counts as a ball, but not to batsman's runs
        runs += x;
        const overEnded = advanceBallAndMaybeOver();
        // strike changes on odd leg byes if over not ended
        if (!overEnded && (x % 2 === 1)) {
          [striker, non_striker] = [non_striker, striker];
        }
        await ensureBowlingRow(bowler);
        await incBowlingRuns(bowler, x);
        commentary = `Leg bye +${x}`;
        if (overEnded) {
          await incBowlerOver(bowler);
          requireNewBowler();
        }
      }

      await saveScore();
      updateDisplay();
    }

    async function addWicket() {
      if (waitingNewBatsman || waitingNewBowler) { alert("Confirm selection first!"); return; }
      pushSnapshot("wicket", { bowler, striker });

      wickets++;
      const overEnded = advanceBallAndMaybeOver();

      // mark striker out
      await ensureBowlingRow(bowler);
      await incBowlingWicket(bowler);
      await supabaseClient.from("batting_stats")
        .update({ is_out: true })
        .eq("match_id", matchId)
        .eq("player_name", striker);

      // record dismissal
      const dismissalType = document.getElementById("dismissalType").value;
      const fielderName = document.getElementById("fielderName")?.value || null;
      await supabaseClient.from("dismissals").insert({
        match_id: matchId,
        batsman: striker,
        bowler: bowler,
        fielder: fielderName,
        dismissal_type: dismissalType
      });

      commentary = `WICKET! ${striker} ${dismissalType}${fielderName ? " by " + fielderName : ""}`;
      await saveScore();
      updateDisplay();

      if (overEnded) {
        await incBowlerOver(bowler);
        requireNewBowler();
      }
      requireNewBatsman();
    }

    function swapStrike(manual=false) {
      if (waitingNewBatsman || waitingNewBowler) return;
      pushSnapshot("swap", {});
      [striker, non_striker] = [non_striker, striker];
      commentary = manual ? "Strike rotated manually." : "Strike rotated.";
      saveScore();
      updateDisplay();
    }

    async function endInnings() {
      // flip teams for next innings
      pushSnapshot("end_innings", {});
      commentary = "Innings ended.";

      // swap teams
      [battingTeam, bowlingTeam] = [bowlingTeam, battingTeam];
      [battingPlayers, bowlingPlayers] = [bowlingPlayers, battingPlayers];

      // reset batter/bowler selections
      striker = "None"; non_striker = "None"; bowler = "None";

      // unlock selectors to choose new players
      document.getElementById("strikerSelect").disabled = false;
      document.getElementById("nonStrikerSelect").disabled = false;
      document.getElementById("bowlerSelect").disabled = false;

      document.getElementById("btnConfirmInitial").disabled = false; // reuse to reconfirm

      // disable scoring until reconfirmed
      document.querySelectorAll(".controls button, .extras button").forEach(el => el.disabled = true);

      await saveScore();
      updateDisplay();
    }

    async function undo() {
      const snap = history.pop(); if (!snap) return;
      restoreSnapshot(snap);
      await saveScore();
      updateDisplay();
      if (history.length === 0) document.getElementById("btnUndo").disabled = true;
      // clear any "waiting" flags/buttons if we undid to a safe state
      waitingNewBatsman = false; waitingNewBowler = false;
      document.getElementById("btnConfirmNewBat").style.display = "none";
      document.getElementById("btnConfirmNewBowler").style.display = "none";
      document.getElementById("strikerSelect").disabled = true;
      document.getElementById("bowlerSelect").disabled = true;
    }

    // ------- START -------
    loadTeams();
  </script>
</body>
</html>
