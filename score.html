<script>
  let score = 0, wickets = 0, balls = 0, overs = 0;
  let striker = "None", nonStriker = "None", bowler = "None";
  let battingTeam = null, bowlingTeam = null;
  let tournamentData = JSON.parse(localStorage.getItem("tournamentData"));
  let lastAction = null;
  let firstInningsScore = null;

  const scriptURL = "https://script.google.com/macros/s/AKfycbyYkUO01c9FpoLwGj_y8ALbPt2_WVvac_W1QxGNkqKnp54VRb6wBEPKmEzpOjuP-7fP6Q/exec";

  function loadTeams() {
    if (tournamentData) {
      battingTeam = tournamentData.team1;
      bowlingTeam = tournamentData.team2;
      document.getElementById("teamName").innerText = battingTeam.name;

      populateDropdown("strikerSelect", battingTeam.players);
      populateDropdown("nonStrikerSelect", battingTeam.players);
      populateDropdown("bowlerSelect", bowlingTeam.players);
    } else {
      battingTeam = { name: "Team A", players: [] };
      bowlingTeam = { name: "Team B", players: [] };
    }
    updateDisplay();
  }

  function populateDropdown(id, players) {
    let dropdown = document.getElementById(id);
    dropdown.innerHTML = "<option value=''>Select</option>";
    players.forEach(p => {
      if (p.trim()) {
        let option = document.createElement("option");
        option.value = p;
        option.text = p;
        dropdown.add(option);
      }
    });
  }

  function updateDisplay() {
    document.getElementById("teamScore").innerText = 
      `Score: ${score}/${wickets} (${overs}.${balls} overs)`;

    let totalOvers = overs + balls / 6;
    let nrr = totalOvers > 0 ? (score / totalOvers).toFixed(2) : "0.00";
    document.getElementById("netRunRate").innerText = `NRR: ${nrr}`;
    document.getElementById("currentBatting").innerText = 
      `Currently batting: ${battingTeam ? battingTeam.name : "None"}`;
    document.getElementById("currentPlayers").innerText = 
      `Striker: ${striker} | Non-Striker: ${nonStriker}`;
    document.getElementById("currentBowler").innerText = `Bowler: ${bowler}`;

    saveToGoogleSheet(); // ðŸ”¥ Save live after every update
  }

  function applyRuns() {
    let runs = parseInt(document.getElementById("runsSelect").value);
    if (isNaN(runs)) return;
    lastAction = { type: "runs", runs: runs };
    addRuns(runs);
  }

  function addRuns(runs) {
    score += runs;
    balls++;
    if (balls >= 6) { overs++; balls = 0; alert("Over completed. Please select next bowler."); }
    if (runs % 2 !== 0) [striker, nonStriker] = [nonStriker, striker];
    updateDisplay();
  }

  function applyExtras() {
    let val = document.getElementById("extrasSelect").value;
    if (!val) return;
    let type = val.slice(0,2), runs = parseInt(val.slice(2));
    lastAction = { type: "extra", subtype: type, runs: runs };
    addExtra(type, runs);
  }

  function addExtra(type, runs) {
    score += runs;
    if (type === "lb") {
      balls++;
      if (balls >= 6) { overs++; balls = 0; alert("Over completed. Please select next bowler."); }
    }
    updateDisplay();
  }

  function fallOfWicket() {
    wickets++;
    lastAction = { type: "wicket" };
    striker = "Choose new striker";
    updateDisplay();
    alert("Wicket fallen! Please set new striker.");
  }

  function undoLast() {
    if (!lastAction) return;
    if (lastAction.type === "runs") {
      score -= lastAction.runs;
      if (balls === 0 && overs > 0) { overs--; balls = 5; } else { balls--; }
    } else if (lastAction.type === "extra") {
      score -= lastAction.runs;
      if (lastAction.subtype === "lb") {
        if (balls === 0 && overs > 0) { overs--; balls = 5; } else { balls--; }
      }
    } else if (lastAction.type === "wicket") {
      wickets--;
      striker = "None";
    }
    lastAction = null;
    updateDisplay();
  }

  function setPlayers() {
    if (document.getElementById("strikerSelect").value) striker = document.getElementById("strikerSelect").value;
    if (document.getElementById("nonStrikerSelect").value) nonStriker = document.getElementById("nonStrikerSelect").value;
    if (document.getElementById("bowlerSelect").value) bowler = document.getElementById("bowlerSelect").value;
    updateDisplay();
  }

  function endOver() {
    [striker, nonStriker] = [nonStriker, striker];
    bowler = "Choose new bowler";
    updateDisplay();
    alert("Over ended! Please choose a new bowler.");
    populateDropdown("bowlerSelect", bowlingTeam.players);
  }

  function endInnings() {
    if (firstInningsScore === null) {
      firstInningsScore = score;
      alert(`Innings ended! ${battingTeam.name} scored ${score}.`);
    } else {
      let target = firstInningsScore + 1;
      document.getElementById("targetMessage").innerText = 
        `${battingTeam.name} needs ${target - score} more runs to win.`;
    }
    [battingTeam, bowlingTeam] = [bowlingTeam, battingTeam];
    score = 0; wickets = 0; balls = 0; overs = 0;
    striker = "None"; nonStriker = "None"; bowler = "None";
    document.getElementById("teamName").innerText = battingTeam.name;
    populateDropdown("strikerSelect", battingTeam.players);
    populateDropdown("nonStrikerSelect", battingTeam.players);
    populateDropdown("bowlerSelect", bowlingTeam.players);
    updateDisplay();
  }

  function resetMatch() {
    score = 0; wickets = 0; balls = 0; overs = 0;
    striker = "None"; nonStriker = "None"; bowler = "None";
    firstInningsScore = null;
    document.getElementById("targetMessage").innerText = "";
    loadTeams();
    alert("Match reset!");
  }

  // ðŸ”¥ Save function to Google Sheet
  async function saveToGoogleSheet() {
    try {
      await fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify({
          team: battingTeam ? battingTeam.name : "Unknown",
          score,
          wickets,
          overs: `${overs}.${balls}`,
          striker,
          nonStriker,
          bowler
        }),
        headers: { "Content-Type": "application/json" }
      });
    } catch (err) {
      console.error("Error saving:", err);
    }
  }

  loadTeams();
</script>
